<!doctype html>
<html lang="mr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Change Audio Speed â€” RDroid Apps</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>

<body>
    <!-- ===== HEADER (UNCHANGED) ===== -->
    <header>
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="logo">
            <img src="../../assets/my_brand_icon.png" alt="RDroid" />
            <div>RDroid <span>Apps</span></div>
        </div>
        <div class="nav-links">
            <a href="../../index.html" class="active">Home</a>
            <a href="../../apps.html">Apps</a>
            <a href="../../about.html">About</a>
            <a href="../../contact.html">Contact</a>
            <a href="../../windows-tools.html">Windows Tools</a>
        </div>
        <a href="../../auth/login.html" class="login-btn">ğŸ”‘ Login</a>
    </header>

    <!-- ===== DRAWER (UNCHANGED) ===== -->
    <nav id="drawer">
        <a href="../../index.html">ğŸ  Home</a>
        <a href="../../apps.html">ğŸ“± Apps</a>
        <a href="../../favorites.html">â­ Favorites</a>
        <a href="../../profile.html">ğŸ‘¤ Profile</a>
        <a href="../../about.html">â„¹ï¸ About</a>
        <a href="../../contact.html">âœ‰ï¸ Contact</a>
        <a href="../../privacy-policy.html">ğŸ”’ Privacy Policy</a>
    </nav>
    <section class="tool-section">
        <div class="card">
            <h1>Change Audio Speed</h1>
            <p class="note">Adjust playback speed. Preview before download.</p>

            <button class="btn btn-ghost" id="pick">ğŸµ Upload Audio</button>
            <input type="file" id="file" accept="audio/*" hidden>

            <div class="row">
                <label>Speed: <b id="speedVal">1.00Ã—</b></label>
                <input type="range" id="speed" min="0.5" max="2" step="0.05" value="1">
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="preserve" checked>
                    Preserve pitch (recommended)
                </label>
            </div>

            <div class="actions">
                <button class="btn" id="previewBtn">â–¶ Preview</button>
                <button class="btn btn-primary" id="applyBtn">Apply</button>
                <button class="btn btn-ghost" id="resetBtn">Reset</button>
                <a id="download" class="btn" style="display:none">Download</a>
            </div>

            <pre id="status">Upload an audio file.</pre>
        </div>
    </section>
    <!-- ===== FOOTER (UNCHANGED) ===== -->
    <footer>Â© 2025 RDroid Apps â€” Audio Tools</footer>
    <script>
        function toggleMenu() {
            document.getElementById('drawer').classList.toggle('open');
        }
        const ctx = new AudioContext();
        let buffer = null;
        let previewSrc = null;

        const pick = document.getElementById("pick");
        const file = document.getElementById("file");
        const speed = document.getElementById("speed");
        const speedVal = document.getElementById("speedVal");
        const preserve = document.getElementById("preserve");
        const previewBtn = document.getElementById("previewBtn");
        const applyBtn = document.getElementById("applyBtn");
        const resetBtn = document.getElementById("resetBtn");
        const download = document.getElementById("download");
        const status = document.getElementById("status");

        speed.oninput = () => {
            speedVal.textContent = parseFloat(speed.value).toFixed(2) + "Ã—";
        };

        pick.onclick = () => file.click();

        file.onchange = async () => {
            status.textContent = "Loading audioâ€¦";
            buffer = await ctx.decodeAudioData(await file.files[0].arrayBuffer());
            status.textContent =
                "Loaded | Duration: " + buffer.duration.toFixed(2) + " sec";
        };

        previewBtn.onclick = () => {
            if (!buffer) return alert("Upload audio first");
            if (previewSrc) previewSrc.stop();

            previewSrc = ctx.createBufferSource();
            previewSrc.buffer = buffer;
            previewSrc.playbackRate.value = speed.value;

            // Preserve pitch = false means chipmunk/slow effect
            previewSrc.detune.value = preserve.checked ? 0 : 0;

            previewSrc.connect(ctx.destination);
            previewSrc.start();
        };

        applyBtn.onclick = async () => {
            if (!buffer) return alert("Upload audio first");

            applyBtn.disabled = true;
            status.textContent = "Processingâ€¦";

            const rate = speed.value;
            const newLength = Math.floor(buffer.length / rate);

            const off = new OfflineAudioContext(
                buffer.numberOfChannels,
                newLength,
                buffer.sampleRate
            );

            const src = off.createBufferSource();
            src.buffer = buffer;
            src.playbackRate.value = rate;
            src.connect(off.destination);
            src.start();

            const out = await off.startRendering();

            const blob = new Blob([audioBufferToWav(out)], { type: "audio/wav" });
            download.href = URL.createObjectURL(blob);
            download.download = "speed-changed.wav";
            download.style.display = "inline-block";

            status.textContent = "Done. Download ready.";
            applyBtn.disabled = false;
        };

        resetBtn.onclick = () => {
            buffer = null;
            if (previewSrc) previewSrc.stop();
            download.style.display = "none";
            status.textContent = "Reset. Upload new file.";
        };

        function audioBufferToWav(buffer) {
            const ch = buffer.numberOfChannels;
            const len = buffer.length * ch * 2 + 44;
            const view = new DataView(new ArrayBuffer(len));
            let p = 0;
            const w = s => { for (let i = 0; i < s.length; i++) view.setUint8(p++, s.charCodeAt(i)); };

            w("RIFF"); view.setUint32(p, 36 + buffer.length * ch * 2, true); p += 4;
            w("WAVEfmt "); view.setUint32(p, 16, true); p += 4;
            view.setUint16(p, 1, true); p += 2;
            view.setUint16(p, ch, true); p += 2;
            view.setUint32(p, buffer.sampleRate, true); p += 4;
            view.setUint32(p, buffer.sampleRate * ch * 2, true); p += 4;
            view.setUint16(p, ch * 2, true); p += 2;
            view.setUint16(p, 16, true); p += 2;
            w("data"); view.setUint32(p, buffer.length * ch * 2, true); p += 4;

            for (let i = 0; i < buffer.length; i++) {
                for (let c = 0; c < ch; c++) {
                    let s = Math.max(-1, Math.min(1, buffer.getChannelData(c)[i]));
                    view.setInt16(p, s < 0 ? s * 0x8000 : s * 0x7fff, true);
                    p += 2;
                }
            }
            return view;
        }
    </script>
</body>

</html>
