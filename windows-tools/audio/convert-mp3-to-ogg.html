<!doctype html>
<html lang="mr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Convert MP3 to OGG ‚Äî RDroid Apps</title>
    <link rel="stylesheet" href="../../css/style.css">
    <!-- LOCAL ffmpeg files -->
    <script src="../../js/ffmpeg/ffmpeg.min.js"></script>
</head>

<body>
    <header>
        <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <div class="logo">
            <img src="../../assets/my_brand_icon.png" alt="RDroid" />
            <div>RDroid <span>Apps</span></div>
        </div>
        <div class="nav-links">
            <a href="../../index.html" class="active">Home</a>
            <a href="../../apps.html">Apps</a>
            <a href="../../about.html">About</a>
            <a href="../../contact.html">Contact</a>
            <a href="../../windows-tools.html">Windows Tools</a>
        </div>
        <a href="../../auth/login.html" class="login-btn">üîë Login</a>
    </header>

    <nav id="drawer">
        <a href="../../index.html">üè† Home</a>
        <a href="../../apps.html">üì± Apps</a>
        <a href="../../favorites.html">‚≠ê Favorites</a>
        <a href="../../profile.html">üë§ Profile</a>
        <a href="../../about.html">‚ÑπÔ∏è About</a>
        <a href="../../contact.html">‚úâÔ∏è Contact</a>
        <a href="../../privacy-policy.html">üîí Privacy Policy</a>
    </nav>

    <section class="tool-section">
        <div class="card">
            <h1>Convert MP3 to OGG</h1>
            <p class="note">MP3 ‡§´‡§æ‡§á‡§≤ OGG ‡§´‡•â‡§∞‡§Æ‡•Ö‡§ü‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡§æ. ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞-‡§∏‡§æ‡§†‡•Ä ‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤ ‡§Ü‡§£‡§ø ‡§≤‡§π‡§æ‡§® ‡§Ü‡§ï‡§æ‡§∞.</p>

            <div id="ffmpeg-loading"
                style="display:block; background:#fff3cd; padding:10px; border-radius:8px; margin-bottom:12px;">
                FFmpeg ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡§æ‡§Ç‡§¨‡§æ (‡§™‡§π‡§ø‡§≤‡•ç‡§Ø‡§æ ‡§µ‡•á‡§≥‡•Ä ‡•ß‡•¶-‡•®‡•¶ ‡§∏‡•á‡§ï‡§Ç‡§¶ ‡§≤‡§æ‡§ó‡•Ç ‡§∂‡§ï‡§§‡§æ‡§§)
                <div style="width:100%; background:#e9ecef; border-radius:4px; margin-top:8px;">
                    <div id="ffmpeg-progress"
                        style="width:0%; height:20px; background:#0aa37f; border-radius:4px; transition:width 0.3s;">
                    </div>
                </div>
            </div>

            <label class="drop" id="dropArea">
                MP3 ‡§´‡§æ‡§á‡§≤ ‡§°‡•ç‡§∞‡•â‡§™ ‡§ï‡§∞‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ
                <button class="btn btn-ghost" id="pickBtn" disabled>‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§æ</button>
                <br><small>‡§ï‡§Æ‡§æ‡§≤ ‡§Ü‡§ï‡§æ‡§∞: ‡•´‡•¶ MB</small>
            </label>
            <input type="file" id="fileInput" accept="audio/mp3,audio/mpeg,.mp3" disabled />

            <div class="row">
                <div class="col">
                    <label class="small">‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ</label>
                    <select id="quality" disabled>
                        <option value="9">‡§â‡§ö‡•ç‡§ö (‡•Ø)</option>
                        <option value="7" selected>‡§Æ‡§ß‡•ç‡§Ø‡§Æ (‡•≠)</option>
                        <option value="5">‡§ï‡§Æ‡•Ä (‡•´)</option>
                    </select>
                </div>
                <div class="col">
                    <label class="small">‡§¨‡§ø‡§ü‡§∞‡•á‡§ü</label>
                    <select id="bitrate" disabled>
                        <option value="192k">192 kbps</option>
                        <option value="128k" selected>128 kbps</option>
                        <option value="96k">96 kbps</option>
                        <option value="64k">64 kbps</option>
                    </select>
                </div>
                <div class="col">
                    <label class="small">‡§∏‡•Ö‡§Æ‡•ç‡§™‡§≤ ‡§∞‡•á‡§ü</label>
                    <select id="samplerate" disabled>
                        <option value="44100">44.1 kHz</option>
                        <option value="22050">22.05 kHz</option>
                        <option value="16000">16 kHz</option>
                    </select>
                </div>
            </div>

            <div id="progress-container" style="display:none; margin-top:12px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span>‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div style="width:100%; background:#e9ecef; border-radius:4px;">
                    <div id="progress-bar"
                        style="width:0%; height:20px; background:#0aa37f; border-radius:4px; transition:width 0.3s;">
                    </div>
                </div>
                <div id="progress-text" style="text-align:center; margin-top:4px; font-size:12px;"></div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;">
                <button class="btn btn-primary" id="convertBtn" disabled>‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡§æ</button>
                <button class="btn btn-secondary" id="cancelBtn" style="display:none">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ</button>
                <a id="downloadLink" class="btn btn-success" style="display:none">üì• OGG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ</a>
                <div id="fileInfo" style="margin-left:auto"></div>
            </div>

            <div id="preview" style="margin-top:12px"></div>
            <pre id="log">FFmpeg ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</pre>
        </div>
        <footer>¬© 2025 RDroid Apps ‚Äî ‡§ë‡§°‡§ø‡§ì ‡§ü‡•Ç‡§≤‡•ç‡§∏</footer>
    </section>

    <script>
        let ffmpeg = null;
        let isConverting = false;
        let cancelConversion = false;

        function toggleMenu() {
            const drawer = document.getElementById('drawer');
            if (drawer) {
                drawer.classList.toggle('open');
            }
        }

        // DOM elements
        const pickBtn = document.getElementById('pickBtn');
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const qualitySelect = document.getElementById('quality');
        const bitrateSelect = document.getElementById('bitrate');
        const samplerateSelect = document.getElementById('samplerate');
        const convertBtn = document.getElementById('convertBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const downloadLink = document.getElementById('downloadLink');
        const preview = document.getElementById('preview');
        const fileInfo = document.getElementById('fileInfo');
        const logEl = document.getElementById('log');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressText = document.getElementById('progress-text');
        const ffmpegLoading = document.getElementById('ffmpeg-loading');
        const ffmpegProgress = document.getElementById('ffmpeg-progress');

        // Helper function to read file as Uint8Array
        async function readFileAsUint8Array(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    resolve(new Uint8Array(reader.result));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Progress update function
        function updateProgress(percent, text) {
            if (progressBar && progressPercent && progressText) {
                progressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
                progressText.textContent = text;

                if (percent % 25 === 0 || percent === 100) {
                    logEl.textContent += `\nüìà ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä: ${percent}% - ${text}`;
                }
            }
        }

        function enableControls() {
            console.log('enableControls called');

            if (pickBtn) {
                pickBtn.disabled = false;
                pickBtn.textContent = '‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§æ';
            }

            if (fileInput) fileInput.disabled = false;

            if (qualitySelect) {
                qualitySelect.disabled = false;
                qualitySelect.style.cursor = 'pointer';
            }

            if (bitrateSelect) {
                bitrateSelect.disabled = false;
                bitrateSelect.style.cursor = 'pointer';
            }

            if (samplerateSelect) {
                samplerateSelect.disabled = false;
                samplerateSelect.style.cursor = 'pointer';
            }

            if (convertBtn) {
                convertBtn.disabled = false;
                convertBtn.style.cursor = 'pointer';
            }

            if (ffmpegLoading) ffmpegLoading.style.display = 'none';

            logEl.textContent = '‚úÖ FFmpeg ‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡•á! ‡§Ü‡§§‡§æ ‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§æ.';
        }

        // FFmpeg ‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ - LOCAL VERSION
        async function loadFFmpeg() {
            try {
                console.log('loadFFmpeg started');
                logEl.textContent = 'FFmpeg ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...';

                if (ffmpegProgress) ffmpegProgress.style.width = '5%';

                // Check if FFmpeg is available
                if (typeof FFmpeg === 'undefined') {
                    throw new Error('FFmpeg ‡§≤‡§æ‡§Ø‡§¨‡•ç‡§∞‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä. ‡§´‡§æ‡§á‡§≤ ‡§§‡§™‡§æ‡§∏‡§æ.');
                }

                const { createFFmpeg } = FFmpeg;

                if (ffmpegProgress) ffmpegProgress.style.width = '20%';

                // CORRECT PATH: ../../js/ffmpeg/ffmpeg-core.js
                const corePath = '../../js/ffmpeg/ffmpeg-core.js';
                console.log('Loading FFmpeg from:', corePath);
                logEl.textContent += `\nCore path: ${corePath}`;

                ffmpeg = createFFmpeg({
                    log: false, // Set to false to reduce console noise
                    corePath: corePath,
                    progress: ({ ratio }) => {
                        const percent = Math.round(ratio * 100);
                        console.log('FFmpeg load progress:', percent);

                        if (ffmpegProgress) {
                            ffmpegProgress.style.width = `${percent}%`;
                        }

                        if (percent < 100) {
                            logEl.textContent = `FFmpeg ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á... ${percent}%`;
                        }

                        if (percent === 100) {
                            console.log('FFmpeg load complete, enabling controls');
                            setTimeout(enableControls, 300);
                        }
                    }
                });

                if (ffmpegProgress) ffmpegProgress.style.width = '40%';
                logEl.textContent += '\nFFmpeg instance ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...';

                console.log('Calling ffmpeg.load()...');
                await ffmpeg.load();
                console.log('ffmpeg.load() completed');

                // Backup: Ensure controls are enabled even if progress callback fails
                if (pickBtn && pickBtn.disabled) {
                    console.log('Manually enabling controls after load');
                    enableControls();
                }

            } catch (error) {
                console.error('FFmpeg load error:', error);
                logEl.textContent = `‚ùå FFmpeg ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${error.message}`;

                // Show detailed error
                if (ffmpegLoading) {
                    ffmpegLoading.innerHTML = `
                        <div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 5px;">
                            <strong>‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä:</strong> ${error.message}<br>
                            <small>‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§ó‡•ã‡§∑‡•ç‡§ü‡•Ä ‡§§‡§™‡§æ‡§∏‡§æ:</small>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>../../js/ffmpeg/ffmpeg.min.js ‡§´‡§æ‡§á‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Ü‡§π‡•á ‡§ï‡§æ?</li>
                                <li>../../js/ffmpeg/ffmpeg-core.js ‡§´‡§æ‡§á‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Ü‡§π‡•á ‡§ï‡§æ? (30MB)</li>
                                <li>../../js/ffmpeg/ffmpeg-core.wasm ‡§´‡§æ‡§á‡§≤ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Ü‡§π‡•á ‡§ï‡§æ? (23MB)</li>
                                <li>‡§´‡§æ‡§á‡§≤ path ‡§¨‡§∞‡•ã‡§¨‡§∞ ‡§Ü‡§π‡•á ‡§ï‡§æ? (../../js/ffmpeg/)</li>
                            </ul>
                            <button onclick="location.reload()" style="padding: 5px 10px; background: #0aa37f; color: white; border: none; border-radius: 3px; cursor: pointer; margin-top:5px;">‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ</button>
                            <button onclick="enableControls()" style="padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; margin-top:5px; margin-left:5px;">‡§´‡§ï‡•ç‡§§ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤‡•ç‡§∏ ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡§æ</button>
                        </div>
                    `;
                }
            }
        }

        // File selection
        if (pickBtn) {
            pickBtn.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Pick button clicked');
                if (fileInput) {
                    fileInput.click();
                }
            });
        }

        // Drop area events
        if (dropArea) {
            dropArea.addEventListener('dragover', e => {
                e.preventDefault();
                dropArea.style.borderColor = '#0aa37f';
            });

            dropArea.addEventListener('drop', e => {
                e.preventDefault();
                dropArea.style.borderColor = '';
                if (e.dataTransfer.files.length) {
                    if (fileInput) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileSelect();
                    }
                }
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.style.borderColor = '';
            });
        }

        // File input change
        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            console.log('File selected:', file.name);

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert('‡§´‡§æ‡§á‡§≤ ‡§Ü‡§ï‡§æ‡§∞ ‡§ñ‡•Ç‡§™ ‡§Æ‡•ã‡§†‡§æ ‡§Ü‡§π‡•á! ‡§ï‡§Æ‡§æ‡§≤ ‡§Ü‡§ï‡§æ‡§∞: 50 MB');
                fileInput.value = '';
                return;
            }

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            if (fileInfo) fileInfo.textContent = `‡§´‡§æ‡§á‡§≤: ${file.name} (${fileSizeMB} MB)`;

            if (preview) {
                const audioUrl = URL.createObjectURL(file);
                preview.innerHTML = `
                    <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="font-size:24px;">üéµ</div>
                            <div>
                                <strong>${file.name}</strong><br>
                                <small>${fileSizeMB} MB ‚Ä¢ MP3 ‚Ä¢ ${getAudioDuration(file)}</small>
                            </div>
                        </div>
                        <audio controls src="${audioUrl}" style="width:100%; margin-top:8px;"></audio>
                    </div>
                `;
            }

            logEl.textContent += `\n‚úÖ ‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§≤‡•Ä: ${file.name}\nüìä ‡§Ü‡§ï‡§æ‡§∞: ${fileSizeMB} MB`;
        }

        function getAudioDuration(file) {
            const sizeInMB = file.size / (1024 * 1024);
            const approxMinutes = Math.round(sizeInMB * 0.5);
            return approxMinutes > 0 ? `~${approxMinutes} ‡§Æ‡§ø‡§®‡§ø‡§ü` : '‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä ‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
        }

        // Conversion process
        if (convertBtn) {
            convertBtn.addEventListener('click', async () => {
                console.log('Convert button clicked');
                console.log('FFmpeg status:', {
                    exists: !!ffmpeg,
                    loaded: ffmpeg ? ffmpeg.loaded : false,
                    isLoadedMethod: ffmpeg ? (typeof ffmpeg.isLoaded) : 'none'
                });

                if (isConverting) {
                    console.log('Already converting, skipping');
                    return;
                }

                const file = fileInput.files[0];
                if (!file) {
                    alert('‡§ï‡•É‡§™‡§Ø‡§æ MP3 ‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§æ');
                    return;
                }

                // FIXED: Check if ffmpeg exists and is loaded
                if (!ffmpeg) {
                    alert('FFmpeg ‡§Ö‡§¶‡•ç‡§Ø‡§æ‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡•ã‡§°‡§æ ‡§µ‡•á‡§≥ ‡§•‡§æ‡§Ç‡§¨‡§æ.');
                    return;
                }

                // Different FFmpeg versions have different ways to check loading
                let isLoaded = false;
                if (typeof ffmpeg.isLoaded === 'function') {
                    isLoaded = ffmpeg.isLoaded();
                } else if (typeof ffmpeg.loaded !== 'undefined') {
                    isLoaded = ffmpeg.loaded;
                } else {
                    // If we can't determine, assume it's loaded if ffmpeg exists
                    isLoaded = true;
                }

                if (!isLoaded) {
                    alert('‡§ï‡•É‡§™‡§Ø‡§æ FFmpeg ‡§≤‡•ã‡§° ‡§π‡•ã‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡§æ (‡§Ö‡§¶‡•ç‡§Ø‡§æ‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á)');
                    return;
                }

                isConverting = true;
                cancelConversion = false;
                convertBtn.disabled = true;
                convertBtn.textContent = '‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...';
                if (cancelBtn) {
                    cancelBtn.style.display = 'inline-block';
                    cancelBtn.disabled = false;
                }
                if (progressContainer) progressContainer.style.display = 'block';
                if (downloadLink) downloadLink.style.display = 'none';

                // Reset progress
                updateProgress(0, '‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...');

                try {
                    console.log('Starting conversion process');
                    logEl.textContent += '\n\n=== ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§∏‡•Å‡§∞‡•Ç ===';
                    logEl.textContent += `\n‡§´‡§æ‡§á‡§≤: ${file.name}`;
                    logEl.textContent += `\n‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§ú: ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ=${qualitySelect.value}, ‡§¨‡§ø‡§ü‡§∞‡•á‡§ü=${bitrateSelect.value}, ‡§∏‡•Ö‡§Æ‡•ç‡§™‡§≤ ‡§∞‡•á‡§ü=${samplerateSelect.value}Hz`;

                    updateProgress(10, '‡§´‡§æ‡§á‡§≤ ‡§µ‡§æ‡§ö‡§§ ‡§Ü‡§π‡•á...');

                    // Load file to FFmpeg
                    const inputFileName = 'input.mp3';
                    const fileData = await readFileAsUint8Array(file);
                    ffmpeg.FS('writeFile', inputFileName, fileData);
                    console.log('File written to FFmpeg filesystem');

                    updateProgress(30, 'MP3 ‡§°‡•Ä‡§ï‡•ã‡§° ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...');

                    // Prepare FFmpeg command
                    const outputFileName = 'output.ogg';
                    const quality = qualitySelect.value;
                    const bitrate = bitrateSelect.value;
                    const samplerate = samplerateSelect.value;

                    // OGG encoding command
                    const command = [
                        '-i', inputFileName,
                        '-c:a', 'libvorbis',
                        '-q:a', quality,
                        '-b:a', bitrate,
                        '-ar', samplerate,
                        '-map_metadata', '0',
                        '-y',
                        outputFileName
                    ];

                    console.log('FFmpeg command:', command);
                    logEl.textContent += `\nFFmpeg ‡§ï‡§Æ‡§æ‡§Ç‡§°: ffmpeg ${command.join(' ')}`;

                    updateProgress(50, 'OGG ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§è‡§®‡•ç‡§ï‡•ã‡§° ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...');

                    // Run FFmpeg
                    console.log('Running FFmpeg...');
                    await ffmpeg.run(...command);
                    console.log('FFmpeg completed successfully');

                    if (cancelConversion) {
                        throw new Error('‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•á‡§≤‡•á');
                    }

                    updateProgress(90, '‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...');

                    // Read output file
                    const data = ffmpeg.FS('readFile', outputFileName);
                    console.log('Output file size:', data.length, 'bytes');

                    updateProgress(95, '‡§¨‡•ç‡§≤‡•â‡§¨ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...');

                    // Create blob
                    const blob = new Blob([data.buffer], { type: 'audio/ogg' });
                    const url = URL.createObjectURL(blob);

                    // Prepare filename
                    const newFileName = file.name.replace(/\.mp3$/i, '') + '.ogg';
                    const newSize = (blob.size / (1024 * 1024)).toFixed(2);
                    const originalSize = (file.size / (1024 * 1024)).toFixed(2);

                    updateProgress(100, '‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£!');

                    // Setup download link
                    if (downloadLink) {
                        downloadLink.href = url;
                        downloadLink.download = newFileName;
                        downloadLink.textContent = `üì• OGG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ (${newSize} MB)`;
                        downloadLink.style.display = 'inline-block';
                    }

                    // Show info
                    if (fileInfo) {
                        fileInfo.innerHTML = `
                    <div style="text-align:right;">
                        <div>‡§Æ‡•Ç‡§≥: ${originalSize} MB</div>
                        <div>‡§®‡§µ‡•Ä‡§®: <strong>${newSize} MB</strong></div>
                    </div>
                `;
                    }

                    // Update preview
                    if (preview) {
                        preview.innerHTML += `
                    <div style="margin-top:12px; background:#e8f5e9; padding:12px; border-radius:8px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="font-size:24px;">‚úÖ</div>
                            <div>
                                <strong>‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£!</strong><br>
                                <small>${newFileName} ‚Ä¢ ${newSize} MB</small>
                            </div>
                        </div>
                        <audio controls src="${url}" style="width:100%; margin-top:8px;"></audio>
                        <div style="margin-top:8px; font-size:12px; color:#666;">
                            ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™: ${originalSize} MB ‚Üí ${newSize} MB (${((1 - newSize / originalSize) * 100).toFixed(1)}% ‡§≤‡§π‡§æ‡§®)
                        </div>
                    </div>
                `;
                    }

                    logEl.textContent += `\n‚úÖ ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£!`;
                    logEl.textContent += `\nüìä ‡§Ü‡§ï‡§æ‡§∞: ${originalSize} MB ‚Üí ${newSize} MB`;
                    logEl.textContent += `\nüìä ‡§Ü‡§ï‡§æ‡§∞ ‡§ï‡§Æ‡•Ä: ${((1 - newSize / originalSize) * 100).toFixed(1)}%`;
                    logEl.textContent += '\n=== ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ===';

                    // Cleanup
                    setTimeout(() => {
                        try {
                            ffmpeg.FS('unlink', inputFileName);
                            ffmpeg.FS('unlink', outputFileName);
                            console.log('Cleaned up temporary files');
                        } catch (cleanupError) {
                            console.warn('Cleanup error:', cleanupError);
                        }
                    }, 1000);

                } catch (error) {
                    console.error('Conversion error:', error);
                    logEl.textContent += `\n‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${error.message}`;

                    if (!cancelConversion) {
                        alert(`‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${error.message}`);
                    } else {
                        logEl.textContent += '\n‚ö†Ô∏è ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•á‡§≤‡•á';
                    }

                    if (preview) {
                        preview.innerHTML += `
                    <div style="margin-top:12px; background:#f8d7da; padding:12px; border-radius:8px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="font-size:24px;">‚ùå</div>
                            <div>
                                <strong>‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä</strong><br>
                                <small>${error.message}</small>
                            </div>
                        </div>
                    </div>
                `;
                    }
                } finally {
                    isConverting = false;
                    convertBtn.disabled = false;
                    convertBtn.textContent = '‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡§æ';
                    if (cancelBtn) {
                        cancelBtn.style.display = 'none';
                        cancelBtn.disabled = false;
                        cancelBtn.textContent = '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ';
                    }

                    // Hide progress bar after 3 seconds
                    setTimeout(() => {
                        if (progressContainer) progressContainer.style.display = 'none';
                    }, 3000);
                }
            });
        }

        // Cancel button
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                console.log('Cancel button clicked');
                if (isConverting) {
                    cancelConversion = true;
                    cancelBtn.disabled = true;
                    cancelBtn.textContent = '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•Ä‡§§ ‡§Ü‡§π‡•á...';
                    logEl.textContent += '\n‚ö†Ô∏è ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä...';
                }
            });
        }

        // Clear log on double click
        if (logEl) {
            logEl.addEventListener('dblclick', () => {
                if (!isConverting) {
                    logEl.textContent = '‡§§‡§Ø‡§æ‡§∞.';
                }
            });
        }

        // Load FFmpeg on page load
        window.addEventListener('load', function () {
            console.log('Page loaded, starting FFmpeg load');
            // Start loading FFmpeg
            loadFFmpeg();

            // Fallback: If controls are still disabled after 8 seconds, enable them manually
            setTimeout(function () {
                if (pickBtn && pickBtn.disabled) {
                    console.log('Fallback: Manually enabling controls');
                    enableControls();
                }
            }, 8000);
        });
    </script>
</body>

</html>
