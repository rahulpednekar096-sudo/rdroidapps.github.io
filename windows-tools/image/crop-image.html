<!doctype html>
<html lang="mr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Crop Image â€” RDroid Apps</title>
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Include jQuery for load function -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- HEADER (loaded from external file) -->
    <div id="header-container"></div>

    <!-- TOOLS QUICK LINKS (loaded from external file) -->
    <div id="tools-links-container"></div>

    <!-- MENU DRAWER (loaded from external file) -->
    <div id="menu-drawer-container"></div>

    <!-- Load all components -->
    <script>
        $(function () {
            $("#header-container").load("../../components/header.html");
            $("#menu-drawer-container").load("../../components/menu-drawer.html");
            $("#tools-links-container").load("../../components/image-tools-quick-links.html");
            $("#footer-container").load("../../components/footer.html");
        });
    </script>

    <section class="tool-section">
        <div class="card">
            <h1>Crop Image</h1>
            <p class="note">Draw a rectangle on the image to crop. Works for large images.</p>

            <label class="drop" id="dropArea">Drop image here or <button class="btn btn-ghost" id="pickBtn">Choose
                    file</button></label>
            <input type="file" id="fileInput" accept="image/*" />
            <div style="margin-top:12px;"><canvas id="canvas"
                    style="max-width:100%;border-radius:6px;background:#0b0c0d"></canvas></div>

            <div style="margin-top:12px;display:flex;gap:8px;">
                <button class="btn btn-primary" id="cropBtn">Crop</button>
                <a id="downloadLink" class="btn" style="display:none"></a>
                <button class="btn btn-ghost" id="clearBtn">Clear</button>
            </div>

            <pre id="log">Ready.</pre>
        </div>
        <!-- FOOTER (loaded from external file) -->
        <div id="footer-container"></div>
    </section>

    <script>
        function toggleMenu() { document.getElementById('drawer').classList.toggle('open') }
        const fileInput = document.getElementById('fileInput'), pickBtn = document.getElementById('pickBtn'), dropArea = document.getElementById('dropArea'),
            canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), cropBtn = document.getElementById('cropBtn'),
            downloadLink = document.getElementById('downloadLink'), clearBtn = document.getElementById('clearBtn'), logEl = document.getElementById('log');

        pickBtn.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.borderColor = '#0aa37f' });
        dropArea.addEventListener('dragleave', () => dropArea.style.borderColor = '');
        dropArea.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; loadFile(); } });

        fileInput.addEventListener('change', loadFile);

        let img = null, isDown = false, start = null, rect = null;
        function log(msg) { logEl.textContent += msg + '\\n'; logEl.scrollTop = logEl.scrollHeight; }

        async function loadFile() {
            const f = fileInput.files[0]; if (!f) return;
            const url = URL.createObjectURL(f); img = new Image(); img.src = url; await img.decode();
            canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
            canvas.style.width = '100%';
            ctx.drawImage(img, 0, 0);
            log('Image loaded: ' + f.name);
        }

        canvas.addEventListener('mousedown', e => {
            if (!img) return;
            isDown = true; const r = canvas.getBoundingClientRect();
            start = { x: Math.round((e.clientX - r.left) * (canvas.width / r.width)), y: Math.round((e.clientY - r.top) * (canvas.height / r.height)) };
        });
        canvas.addEventListener('mousemove', e => {
            if (!isDown || !img) return;
            const r = canvas.getBoundingClientRect(); const x = Math.round((e.clientX - r.left) * (canvas.width / r.width)), y = Math.round((e.clientY - r.top) * (canvas.height / r.height));
            rect = { x: Math.min(start.x, x), y: Math.min(start.y, y), w: Math.abs(x - start.x), h: Math.abs(y - start.y) }; redraw();
        });
        canvas.addEventListener('mouseup', () => { isDown = false; });

        function redraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); if (rect) { ctx.strokeStyle = '#0aa37f'; ctx.lineWidth = 3; ctx.strokeRect(rect.x, rect.y, rect.w, rect.h); ctx.fillStyle = 'rgba(10,163,127,0.12)'; ctx.fillRect(rect.x, rect.y, rect.w, rect.h); } }

        cropBtn.addEventListener('click', () => {
            if (!rect) return alert('Select area to crop');
            const out = document.createElement('canvas'); out.width = rect.w; out.height = rect.h;
            out.getContext('2d').drawImage(canvas, rect.x, rect.y, rect.w, rect.h, 0, 0, rect.w, rect.h);
            out.toBlob(b => {
                const url = URL.createObjectURL(b); downloadLink.href = url; downloadLink.download = 'cropped.png'; downloadLink.textContent = 'Download cropped image'; downloadLink.style.display = 'inline-block';
            }, 'image/png');
        });
        clearBtn.addEventListener('click', () => { rect = null; redraw(); downloadLink.style.display = 'none'; log('Cleared selection'); });
    </script>
</body>

</html>
