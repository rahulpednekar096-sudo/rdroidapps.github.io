<!doctype html>
<html lang="mr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Watermark — RDroid Apps</title>
    <link rel="stylesheet" href="../../css/style.css">
    
    <!-- Include jQuery for load function -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- HEADER (loaded from external file) -->
    <div id="header-container"></div>

    <!-- TOOLS QUICK LINKS (loaded from external file) -->
    <div id="tools-links-container"></div>

    <!-- MENU DRAWER (loaded from external file) -->
    <div id="menu-drawer-container"></div>

    <!-- Load all components -->
    <script>
        $(function () {
            $("#header-container").load("../../components/header.html");
            $("#menu-drawer-container").load("../../components/menu-drawer.html");
            $("#tools-links-container").load("../../components/image-tools-quick-links.html");
            $("#footer-container").load("../../components/footer.html");
        });
    </script>

    <section class="tool-section">
        <div class="card">
            <h1>Add Watermark</h1>
            <p class="note">Add text or image watermark. Drag to position (text watermark supported).</p>

            <div class="drop" id="dropArea">Drop image or <button class="btn btn-ghost" id="pickBtn">Choose
                    file</button></div>
            <input type="file" id="fileInput" accept="image/*" />
            <hr>
            <div class="row">
                <div class="col"><label class="small">Type</label><select id="wmType">
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                    </select></div>
                <div class="col" id="textOpts"><label class="small">Text</label><input id="wmText"
                        placeholder="© RDroid Apps"></div>
                <div class="col" id="imageOpts" style="display:none"><label class="small">Watermark image</label><input
                        type="file" id="wmImage" accept="image/*" /></div>
                <div class="col"><label class="small">Opacity</label><input type="range" id="wmOpacity" min="10"
                        max="100" value="60">
                    <div id="opVal">60%</div>
                </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;"><button class="btn btn-primary" id="applyBtn">Apply
                    watermark</button><a id="downloadLink" class="btn" style="display:none"></a></div>

            <div id="preview" style="margin-top:12px"></div>
            <pre id="log">Ready.</pre>
        </div>
    </section>
    <!-- FOOTER (loaded from external file) -->
    <div id="footer-container"></div>
    <script>
        function toggleMenu() { document.getElementById('drawer').classList.toggle('open') }
        const pickBtn = document.getElementById('pickBtn'), fileInput = document.getElementById('fileInput'),
            dropArea = document.getElementById('dropArea'), wmType = document.getElementById('wmType'),
            textOpts = document.getElementById('textOpts'), imageOpts = document.getElementById('imageOpts'),
            wmText = document.getElementById('wmText'), wmImage = document.getElementById('wmImage'),
            wmOpacity = document.getElementById('wmOpacity'), opVal = document.getElementById('opVal'),
            applyBtn = document.getElementById('applyBtn'), preview = document.getElementById('preview'),
            downloadLink = document.getElementById('downloadLink'), logEl = document.getElementById('log');

        pickBtn.addEventListener('click', () => fileInput.click()); dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.borderColor = '#0aa37f' }); dropArea.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files.length) fileInput.files = e.dataTransfer.files; });
        wmImage.addEventListener('change', () => {
            if (!wmImage.files.length) return;

            const f = wmImage.files[0];
            const url = URL.createObjectURL(f);

            // Preview for debugging (optional)
            logEl.textContent = "Watermark image selected: " + f.name;
        });

        wmType.addEventListener('change', () => { if (wmType.value === 'text') { textOpts.style.display = 'block'; imageOpts.style.display = 'none'; } else { textOpts.style.display = 'none'; imageOpts.style.display = 'block'; } });
        wmOpacity.addEventListener('input', () => opVal.textContent = wmOpacity.value + '%');

        let currentFile = null;
        fileInput.addEventListener('change', () => { currentFile = fileInput.files[0]; preview.innerHTML = `<img id="loaded" src="${URL.createObjectURL(currentFile)}" style="max-width:420px;border-radius:8px">`; });

        applyBtn.addEventListener('click', async () => {
            if (!currentFile) return alert('कृपया image निवडा');
            const reader = new FileReader(); reader.onload = async e => {
                const img = new Image(); img.src = e.target.result; await img.decode();
                const canvas = document.createElement('canvas'); canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                ctx.globalAlpha = parseInt(wmOpacity.value) / 100;
                if (wmType.value === 'text') {
                    const text = wmText.value || '© RDroid Apps';
                    const fontSize = Math.max(16, Math.round(canvas.width / 20));
                    ctx.font = `${fontSize}px sans-serif`; ctx.textBaseline = 'bottom';
                    const textWidth = ctx.measureText(text).width;
                    // bottom-right default
                    const x = canvas.width - textWidth - 20, y = canvas.height - 20;
                    ctx.fillStyle = 'white'; ctx.strokeStyle = 'rgba(0,0,0,0.45)'; ctx.lineWidth = 3;
                    ctx.strokeText(text, x, y); ctx.fillText(text, x, y);
                } else {
                    const wmF = wmImage.files[0];
                    if (!wmF) return alert("कृपया watermark image निवडा");

                    // Read watermark image from file
                    const wmi = new Image();
                    wmi.src = URL.createObjectURL(wmF);

                    wmi.onload = () => {
                        // Auto scaling based on base image size
                        const scale = Math.min(0.25, canvas.width / (wmi.naturalWidth * 3));
                        const w = Math.round(wmi.naturalWidth * scale);
                        const h = Math.round(wmi.naturalHeight * scale);

                        const x = canvas.width - w - 20;
                        const y = canvas.height - h - 20;

                        ctx.drawImage(wmi, x, y, w, h);

                        // Output final image
                        canvas.toBlob(b => {
                            const url = URL.createObjectURL(b);
                            preview.innerHTML = `<img src="${url}" style="max-width:420px;border-radius:8px">`;
                            downloadLink.href = url;
                            downloadLink.download = currentFile.name.replace(/\.[^/.]+$/, "") + "-wm.png";
                            downloadLink.textContent = "Download";
                            downloadLink.style.display = "inline-block";
                        }, "image/png");
                    };
                    return;
                }

                ctx.globalAlpha = 1;
                canvas.toBlob(b => { const url = URL.createObjectURL(b); preview.innerHTML = `<img src="${url}" style="max-width:420px;border-radius:8px">`; downloadLink.href = url; downloadLink.download = currentFile.name.replace(/\.[^/.]+$/, '') + '-wm.png'; downloadLink.textContent = 'Download'; downloadLink.style.display = 'inline-block'; }, 'image/png');
            }; reader.readAsDataURL(currentFile);
        });
    </script>
</body>

</html>
