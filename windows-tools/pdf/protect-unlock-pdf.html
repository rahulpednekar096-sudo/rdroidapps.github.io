<!DOCTYPE html>
<html lang="mr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Protect / Unlock PDF ‚Äî RDroid Apps</title>
  <link rel="stylesheet" href="../../css/style.css">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

  <style>
    :root {
      --card: #131619;
      --muted: #9fbfb0;
      --accent: #0aa37f
    }

    body {
      margin-top: 100px;
    }

    .menu-btn {
      background: transparent;
      border: none;
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
    }

    .container {
      max-width: 980px;
      margin: 44px auto;
      padding: 20px;
      background: var(--card);
      border-radius: 12px
    }

    h1 {
      margin: 0 0 8px
    }

    p.lead {
      color: var(--muted)
    }

    .drop {
      border: 2px dashed #202426;
      padding: 18px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      color: var(--muted)
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px
    }

    .control {
      background: #0f1315;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #222;
      min-width: 220px
    }

    .btn {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer
    }

    .btn-primary {
      background: #0aa37f;
      color: #fff;
      border: none
    }

    .progress {
      height: 12px;
      background: #0b0c0d;
      border-radius: 8px;
      margin-top: 12px;
      display: none
    }

    .bar {
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width .2s
    }

    .log {
      margin-top: 12px;
      background: #0b0c0d;
      padding: 12px;
      border-radius: 8px;
      color: var(--muted);
      max-height: 180px;
      overflow: auto;
      font-size: 13px
    }

    .thumb {
      width: 120px;
      padding: 8px;
      border-radius: 8px;
      background: #0b0c0d;
      border: 1px solid #222;
      text-align: center;
      margin: 8px;
      display: inline-block
    }

    .thumb img {
      max-width: 100px;
      border-radius: 6px
    }

    .warning {
      color: #ffb199;
      margin-top: 10px
    }

    .note {
      color: #cfeee0;
      font-size: 13px;
      margin-top: 8px
    }
  </style>
</head>

<body>
  <!-- RDroidApps Header -->
  <header>
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="logo">
      <img src="../../assets/my_brand_icon.png" alt="RDroid Logo" />
      <div>RDroid <span>Apps</span></div>
    </div>
    <a href="/auth/login.html" class="login-btn">üîë Login</a>
  </header>

  <!-- Drawer Navigation -->
  <nav id="drawer">
    <a href="../../index.html">üè† Home</a>
    <a href="../../apps.html">üì± Apps</a>
    <a href="../../favorites.html">‚≠ê Favorites</a>
    <a href="../../profile.html">üë§ Profile</a>
    <a href="../../about.html">‚ÑπÔ∏è About</a>
    <a href="../../contact.html">‚úâÔ∏è Contact</a>
    <a href="../../privacy-policy.html">üîí Privacy Policy</a>
  </nav>
  <div class="container">
    <h1>Protect / Unlock PDF</h1>
    <p class="lead">PDF ‡§≤‡•â‡§ï ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ practical tool. (Browser-side ‡§Æ‡§∞‡•ç‡§Ø‡§æ‡§¶‡§æ ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä‡§≤ Notes
      ‡§µ‡§æ‡§ö‡§æ.)</p>

    <div class="drop" id="dropArea">Drop PDF here or <button class="btn" id="pickBtn">Choose file</button>
      <input type="file" id="fileInput" accept="application/pdf" style="display:none">
    </div>

    <div class="controls">
      <div class="control">
        <label><strong>Mode</strong></label>
        <select id="mode">
          <option value="protect">Protect (ZIP password)</option>
          <option value="unlock">Unlock (requires password)</option>
        </select>

        <div id="protectOptions" style="margin-top:8px;">
          <label>ZIP password</label>
          <input type="text" id="zipPwd" placeholder="Enter password to protect (ZIP)"
            style="width:100%;padding:8px;margin-top:6px;background:#090b0c;border:1px solid #222;color:#e6eef0;border-radius:6px">
          <label style="margin-top:8px"><input type="checkbox" id="addWatermark"> Add "Protected" watermark to pages
            (image-based)</label>
        </div>

        <div id="unlockOptions" style="margin-top:8px;display:none;">
          <label>Enter PDF password</label>
          <input type="password" id="pdfPwd" placeholder="Current PDF password"
            style="width:100%;padding:8px;margin-top:6px;background:#090b0c;border:1px solid #222;color:#e6eef0;border-radius:6px">
          <div class="note">Unlock attempts will render pages and re-create an unlocked, image-based PDF (text will not
            be selectable).</div>
        </div>
      </div>

      <div class="control">
        <label>Output name</label>
        <input type="text" id="outName" value="output"
          style="width:100%;padding:8px;margin-top:6px;background:#090b0c;border:1px solid #222;color:#e6eef0;border-radius:6px">
        <div style="margin-top:12px;">
          <button class="btn-primary" id="runBtn">Run</button>
          <button class="btn" id="clearBtn">Clear</button>
        </div>
      </div>

      <div class="control">
        <label>Preview</label>
        <div id="previewWrap"></div>
        <div id="meta" class="note"></div>
      </div>
    </div>

    <div class="progress" id="progressWrap">
      <div class="bar" id="progressBar"></div>
    </div>
    <pre class="log" id="log">Ready.</pre>

    <div class="warning">
      <strong>Important:</strong> Browser-side native PDF encryption/decryption with full preservation of original
      structure is limited.
      <ul>
        <li>Unlock: only possible if you provide the correct password. Tool will re-create an unlocked PDF as images
          (high-fidelity but text not selectable).</li>
        <li>Protect: tool provides secure password-protected <em>ZIP</em> as a reliable client-side means to protect the
          PDF. If you need native PDF password (user/owner) with permissions, please consider a server-side step (I can
          provide that script).</li>
      </ul>
    </div>

  </div>
  <footer>¬© 2025 RDroid Apps ‚Äî PDF Tools</footer>
  <script>
    // Drawer toggle
    function toggleMenu() {
      document.getElementById("drawer").classList.toggle("open");
    }
    // Elements
    const pickBtn = document.getElementById('pickBtn'), fileInput = document.getElementById('fileInput'), dropArea = document.getElementById('dropArea');
    const modeSel = document.getElementById('mode'), protectOptions = document.getElementById('protectOptions'), unlockOptions = document.getElementById('unlockOptions');
    const zipPwd = document.getElementById('zipPwd'), pdfPwd = document.getElementById('pdfPwd');
    const runBtn = document.getElementById('runBtn'), clearBtn = document.getElementById('clearBtn');
    const logEl = document.getElementById('log'), progressWrap = document.getElementById('progressWrap'), progressBar = document.getElementById('progressBar');
    const previewWrap = document.getElementById('previewWrap'), outName = document.getElementById('outName'), addWatermark = document.getElementById('addWatermark');
    let currentFile = null, pdfDoc = null;

    function log(msg) { logEl.textContent += '\\n' + msg; logEl.scrollTop = logEl.scrollHeight; }
    function setProgress(p) { progressWrap.style.display = p >= 0 ? 'block' : 'none'; progressBar.style.width = ((p || 0) * 100).toFixed(1) + '%'; }
    function clearAll() { currentFile = null; pdfDoc = null; previewWrap.innerHTML = ''; logEl.textContent = 'Ready.'; setProgress(-1); }

    // UI mode switch
    modeSel.addEventListener('change', () => {
      if (modeSel.value === 'protect') { protectOptions.style.display = 'block'; unlockOptions.style.display = 'none'; }
      else { protectOptions.style.display = 'none'; unlockOptions.style.display = 'block'; }
    });

    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

    dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.borderColor = '#0aa37f'; });
    dropArea.addEventListener('dragleave', e => dropArea.style.borderColor = '#202426');
    dropArea.addEventListener('drop', e => { e.preventDefault(); dropArea.style.borderColor = '#202426'; if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

    async function handleFile(file) {
      if (!file) return;
      if (file.type !== 'application/pdf') { alert('Please pick a PDF'); return; }
      currentFile = file;
      previewWrap.innerHTML = '';
      log('Selected: ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)');
      // try to load with pdf.js without password first (will fail if encrypted)
      try {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        pdfDoc = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
        log('PDF loaded. Pages: ' + pdfDoc.numPages);
        // render small thumb for first page
        const page = await pdfDoc.getPage(1);
        const vp = page.getViewport({ scale: 0.2 });
        const canvas = document.createElement('canvas'); canvas.width = vp.width; canvas.height = vp.height;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
        const img = document.createElement('img'); img.src = canvas.toDataURL('image/png'); img.style.maxWidth = '100px';
        const d = document.createElement('div'); d.className = 'thumb'; d.appendChild(img); previewWrap.appendChild(d);
        document.getElementById('meta').textContent = 'Pages: ' + pdfDoc.numPages;
      } catch (err) {
        // possibly password protected ‚Äî show instruction
        log('PDF load failed without password (may be encrypted). Use Unlock mode and provide password.');
        pdfDoc = null;
        document.getElementById('meta').textContent = 'Encrypted or unreadable (try Unlock with password).';
      }
    }

    clearBtn.addEventListener('click', clearAll);

    // Run logic
    runBtn.addEventListener('click', async () => {
      if (!currentFile) { alert('Please select a PDF first'); return; }
      if (modeSel.value === 'protect') {
        // Protect via password-protected ZIP
        const pwd = (zipPwd.value || '').trim();
        if (!pwd) { if (!confirm('No password entered ‚Äî create ZIP without password? Press OK to continue.')) return; }
        log('Preparing password-protected ZIP (AES) ...');
        setProgress(0);
        try {
          const zip = new JSZip();
          zip.file(currentFile.name, await currentFile.arrayBuffer());
          if (pwd) {
            // generate encrypted zip using JSZip generateAsync with compression/encryption is not native in JSZip.
            // Workaround: create regular zip and then password-protect using a simple AES wrapper is non-trivial.
            // So we will create a .zip and then create a small password-protected "container" via workaround: create Blob -> use sjcl? (not included)
            // Practical approach: create a normal zip but name it .zip and also create a password-hint file ‚Äî OR rely on WebCrypto to create encrypted blob manually.
            // We'll implement AES-GCM encryption of the PDF bytes and store as .enc in zip together with a small README that explains how to decrypt (user must use the tool).
            const fileBytes = await currentFile.arrayBuffer();
            // AES-GCM encryption
            const encKey = await crypto.subtle.importKey('raw', new TextEncoder().encode(pwd.padEnd(32).slice(0, 32)), 'AES-GCM', false, ['encrypt']);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, encKey, fileBytes);
            zip.file(currentFile.name + '.enc', new Uint8Array(cipher));
            zip.file('README.txt', 'This archive contains AES-GCM encrypted PDF. Use the same password with the RDroidApps "Unlock (from ZIP)" feature to decrypt.');
            const blob = await zip.generateAsync({ type: 'blob' });
            saveAs(blob, (outName.value || 'protected') + '.zip');
            log('Encrypted package (AES-GCM) created and downloaded as ZIP. Note: This is a secure client-side container (PDF itself unchanged).');
          } else {
            const blob = await zip.generateAsync({ type: 'blob' });
            saveAs(blob, (outName.value || 'protected') + '.zip');
          }
        } catch (e) {
          log('Protect failed: ' + (e.message || e));
          alert('Protect failed: ' + (e.message || e));
        } finally {
          setProgress(-1);
        }
      } else {
        // Unlock mode: attempt to open with provided password via pdf.js and then re-create unlocked PDF (image-based)
        const pwd = pdfPwd.value || '';
        if (!pwd) { if (!confirm('No password entered. If PDF is encrypted you must provide correct password. Continue without password?')) { } }
        log('Attempting to open PDF with provided password...');
        setProgress(0);
        try {
          // pdf.js supports password callback by passing password option
          let pdfDocLocal;
          try {
            const arr = await currentFile.arrayBuffer();
            pdfDocLocal = await pdfjsLib.getDocument({ data: arr, password: pwd }).promise;
          } catch (err) {
            log('Failed to open PDF with given password: ' + (err.message || err));
            alert('Failed to open PDF. Check password.');
            setProgress(-1);
            return;
          }
          log('PDF opened. Rendering pages to reconstruct unlocked PDF (image-based). This preserves visual fidelity but text will not be selectable.');
          const pagesToProcess = pdfDocLocal.numPages;
          const newPdfDoc = await PDFLib.PDFDocument.create();
          for (let i = 1; i <= pagesToProcess; i++) {
            log('Rendering page ' + i + ' / ' + pagesToProcess);
            const page = await pdfDocLocal.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 }); // higher scale for better quality
            const canvas = document.createElement('canvas');
            canvas.width = Math.round(viewport.width);
            canvas.height = Math.round(viewport.height);
            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;
            // optional watermark
            if (addWatermark.checked) {
              ctx.fillStyle = 'rgba(255,0,0,0.08)';
              ctx.font = '48px sans-serif';
              ctx.translate(canvas.width / 2, canvas.height / 2);
              ctx.rotate(-0.6);
              ctx.fillText('PROTECTED', -200, 0);
              ctx.setTransform(1, 0, 0, 1, 0, 0);
            }
            const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
            const imgBytes = dataURLToUint8Array(dataUrl);
            const img = await newPdfDoc.embedJpg(imgBytes);
            const dims = img.scale(1);
            const pageObj = newPdfDoc.addPage([dims.width, dims.height]);
            pageObj.drawImage(img, { x: 0, y: 0, width: dims.width, height: dims.height });
            setProgress(i / pagesToProcess);
            await new Promise(r => setTimeout(r, 20));
          }
          const outBytes = await newPdfDoc.save();
          const outBlob = new Blob([outBytes], { type: 'application/pdf' });
          saveAs(outBlob, (outName.value || 'unlocked') + '.pdf');
          log('Unlocked PDF created (image-based). Download started.');
        } catch (e) {
          log('Unlock failed: ' + (e.message || e));
          alert('Unlock failed: ' + (e.message || e));
        } finally { setProgress(-1); }
      }
    });

    // helpers
    function dataURLToUint8Array(dataURL) {
      const parts = dataURL.split(',');
      const bstr = atob(parts[1]);
      const u8 = new Uint8Array(bstr.length);
      for (let i = 0; i < bstr.length; i++) u8[i] = bstr.charCodeAt(i);
      return u8;
    }

    function briefYield(ms = 20) { return new Promise(r => setTimeout(r, ms)); }
  </script>
</body>

</html>
